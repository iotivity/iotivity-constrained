From ebeab7b16850e7d17ba4909df04491171056e8ff Mon Sep 17 00:00:00 2001
From: Oleksii Beketov <ol.beketov@samsung.com>
Date: Tue, 24 Jul 2018 17:38:31 +0300
Subject: [PATCH] mbedtls reduce

Signed-off-by: Oleksii Beketov <ol.beketov@samsung.com>
---
 library/oid.c     |  5 +++++
 library/pkcs5.c   | 10 ++++++++++
 library/ssl_tls.c |  5 +++++
 library/x509.c    | 15 +++++++++++++++
 4 files changed, 35 insertions(+)

diff --git a/library/oid.c b/library/oid.c
index f13826e..29173c2 100644
--- a/library/oid.c
+++ b/library/oid.c
@@ -670,6 +670,7 @@ FN_OID_GET_ATTR2(mbedtls_oid_get_pkcs12_pbe_alg, oid_pkcs12_pbe_alg_t, pkcs12_pb
 int mbedtls_oid_get_numeric_string( char *buf, size_t size,
                             const mbedtls_asn1_buf *oid )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret;
     size_t i, n;
     unsigned int value;
@@ -705,6 +706,10 @@ int mbedtls_oid_get_numeric_string( char *buf, size_t size,
     }
 
     return( (int) ( size - n ) );
+#else
+    oc_abort("mbedtls_oid_get_numeric_string: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 
 #endif /* MBEDTLS_OID_C */
diff --git a/library/pkcs5.c b/library/pkcs5.c
index 7405fc3..c074c9a 100644
--- a/library/pkcs5.c
+++ b/library/pkcs5.c
@@ -55,6 +55,7 @@ static int pkcs5_parse_pbkdf2_params( const mbedtls_asn1_buf *params,
                                       mbedtls_asn1_buf *salt, int *iterations,
                                       int *keylen, mbedtls_md_type_t *md_type )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret;
     mbedtls_asn1_buf prf_alg_oid;
     unsigned char *p = params->p;
@@ -106,6 +107,10 @@ static int pkcs5_parse_pbkdf2_params( const mbedtls_asn1_buf *params,
                 MBEDTLS_ERR_ASN1_LENGTH_MISMATCH );
 
     return( 0 );
+#else
+    oc_abort("pkcs5_parse_pbkdf2_params: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 
 int mbedtls_pkcs5_pbes2( const mbedtls_asn1_buf *pbe_params, int mode,
@@ -113,6 +118,7 @@ int mbedtls_pkcs5_pbes2( const mbedtls_asn1_buf *pbe_params, int mode,
                  const unsigned char *data, size_t datalen,
                  unsigned char *output )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret, iterations = 0, keylen = 0;
     unsigned char *p, *end;
     mbedtls_asn1_buf kdf_alg_oid, enc_scheme_oid, kdf_alg_params, enc_scheme_params;
@@ -212,6 +218,10 @@ exit:
     mbedtls_cipher_free( &cipher_ctx );
 
     return( ret );
+#else
+    oc_abort("mbedtls_pkcs5_pbes2: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 
 int mbedtls_pkcs5_pbkdf2_hmac( mbedtls_md_context_t *ctx, const unsigned char *password,
diff --git a/library/ssl_tls.c b/library/ssl_tls.c
index d51230d..81cebfe 100644
--- a/library/ssl_tls.c
+++ b/library/ssl_tls.c
@@ -8436,6 +8436,7 @@ int mbedtls_ssl_get_key_exchange_md_tls1_2( mbedtls_ssl_context *ssl,
                                        unsigned char *data, size_t data_len,
                                        mbedtls_md_type_t md_alg )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret = 0;
     mbedtls_md_context_t ctx;
     const mbedtls_md_info_t *md_info = mbedtls_md_info_from_type( md_alg );
@@ -8483,6 +8484,10 @@ exit:
                                         MBEDTLS_SSL_ALERT_MSG_INTERNAL_ERROR );
 
     return( ret );
+#else
+    oc_abort("mbedtls_ssl_get_key_exchange_md_tls1_2: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 #endif /* MBEDTLS_SSL_PROTO_TLS1 || MBEDTLS_SSL_PROTO_TLS1_1 || \
           MBEDTLS_SSL_PROTO_TLS1_2 */
diff --git a/library/x509.c b/library/x509.c
index 8f77559..809b686 100644
--- a/library/x509.c
+++ b/library/x509.c
@@ -747,6 +747,7 @@ int mbedtls_x509_get_ext( unsigned char **p, const unsigned char *end,
  */
 int mbedtls_x509_dn_gets( char *buf, size_t size, const mbedtls_x509_name *dn )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret;
     size_t i, n;
     unsigned char c, merge = 0;
@@ -801,6 +802,10 @@ int mbedtls_x509_dn_gets( char *buf, size_t size, const mbedtls_x509_name *dn )
     }
 
     return( (int) ( size - n ) );
+#else
+    oc_abort("mbedtls_x509_dn_gets: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 
 /*
@@ -809,6 +814,7 @@ int mbedtls_x509_dn_gets( char *buf, size_t size, const mbedtls_x509_name *dn )
  */
 int mbedtls_x509_serial_gets( char *buf, size_t size, const mbedtls_x509_buf *serial )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret;
     size_t i, n, nr;
     char *p;
@@ -836,6 +842,10 @@ int mbedtls_x509_serial_gets( char *buf, size_t size, const mbedtls_x509_buf *se
     }
 
     return( (int) ( size - n ) );
+#else
+    oc_abort("mbedtls_x509_serial_gets: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 
 /*
@@ -845,6 +855,7 @@ int mbedtls_x509_sig_alg_gets( char *buf, size_t size, const mbedtls_x509_buf *s
                        mbedtls_pk_type_t pk_alg, mbedtls_md_type_t md_alg,
                        const void *sig_opts )
 {
+#ifndef ST_MBEDTLS_OPT
     int ret;
     char *p = buf;
     size_t n = size;
@@ -881,6 +892,10 @@ int mbedtls_x509_sig_alg_gets( char *buf, size_t size, const mbedtls_x509_buf *s
 #endif /* MBEDTLS_X509_RSASSA_PSS_SUPPORT */
 
     return( (int)( size - n ) );
+#else
+    oc_abort("mbedtls_x509_sig_alg_gets: cut out due optimization");
+    return( 0 );
+#endif  /* ST_MBEDTLS_OPT */
 }
 
 /*
-- 
1.9.1

