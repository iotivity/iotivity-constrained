/****************************************************************************
 *
 * Copyright 2018 Samsung Electronics All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied. See the License for the specific
 * language governing permissions and limitations under the License.
 *
 ****************************************************************************/

extern "C"{
    #include "sttestcommon.h"
    #include "oc_endpoint.h"
    #include "oc_api.h"
#ifdef OC_SECURITY
    #include "security/oc_store.h"
#endif /* OC_SECURITY */
}

#ifdef OC_SECURITY
static unsigned char acl_data[] = {
    0xa4, 0x62, 0x72, 0x74, 0x81, 0x69, 0x6f, 0x69, 0x63, 0x2e, 0x72, 0x2e,
    0x61, 0x63, 0x6c, 0x62, 0x69, 0x66, 0x81, 0x6f, 0x6f, 0x69, 0x63, 0x2e,
    0x69, 0x66, 0x2e, 0x62, 0x61, 0x73, 0x65, 0x6c, 0x69, 0x6e, 0x65, 0x66,
    0x61, 0x63, 0x6c, 0x69, 0x73, 0x74, 0xa1, 0x64, 0x61, 0x63, 0x65, 0x73,
    0x81, 0xa4, 0x68, 0x63, 0x6f, 0x6e, 0x6e, 0x74, 0x79, 0x70, 0x65, 0x6a,
    0x61, 0x6e, 0x6f, 0x6e, 0x2d, 0x63, 0x6c, 0x65, 0x61, 0x72, 0x69, 0x72,
    0x65, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65, 0x73, 0x81, 0xa4, 0x64, 0x68,
    0x72, 0x65, 0x66, 0x61, 0x2a, 0x63, 0x72, 0x65, 0x6c, 0x60, 0x62, 0x72,
    0x74, 0x81, 0x60, 0x62, 0x69, 0x66, 0x81, 0x6f, 0x6f, 0x69, 0x63, 0x2e,
    0x69, 0x66, 0x2e, 0x62, 0x61, 0x73, 0x65, 0x6c, 0x69, 0x6e, 0x65, 0x6a,
    0x70, 0x65, 0x72, 0x6d, 0x69, 0x73, 0x73, 0x69, 0x6f, 0x6e, 0x18, 0x3f,
    0x65, 0x61, 0x63, 0x65, 0x69, 0x64, 0x01, 0x6a, 0x72, 0x6f, 0x77, 0x6e,
    0x65, 0x72, 0x75, 0x75, 0x69, 0x64, 0x78, 0x24, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x2d, 0x30, 0x30, 0x30, 0x30, 0x2d, 0x30, 0x30,
    0x30, 0x30, 0x2d, 0x30, 0x30, 0x30, 0x30, 0x2d, 0x30, 0x30, 0x30, 0x30,
    0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30
};

static unsigned int acl_data_len = 188;
#endif /* OC_SECURITY */

void
reset_storage(void)
{
    remove("./st_things_creds/acl_0");
    remove("./st_things_creds/cred_0");
    remove("./st_things_creds/doxm_0");
    remove("./st_things_creds/pstat_0");
    remove("./st_things_creds/st_info");
    remove("./st_things_creds/st_info_secure");
}

int
test_wait_until(st_mutex_t mutex, st_cond_t cv, int wait_seconds)
{
    st_mutex_lock(mutex);
    oc_clock_time_t wait_time = oc_clock_time() + wait_seconds * OC_CLOCK_SECOND;
    int ret = st_cond_timedwait(cv, mutex, wait_time);
    st_mutex_unlock(mutex);
    return ret;
}

void
get_wildcard_acl_policy(void)
{
#ifdef OC_SECURITY
    oc_storage_write("acl_0", acl_data, acl_data_len);
    oc_sec_load_acl(0);
#endif /* OC_SECURITY */
}