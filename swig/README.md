Java Language binding for IoTivity-lite using SWIG
-------------------------------------------------

Introduction
=================================================
This uses a tool called SWIG to generate Java language bindings for
IoTivity-lite.  SWIG is an interface compiler that connect programs written
in C and C++ with other languages such as Java.

SWIG is not a stubs generator. It produces code that can be compiled and
used. The output is generated by a tool.  For this reason there is not fancy
encapsulation of the code to make it appear more like what most
developers would expect when using Java code.  The output is not organized
into classes. The output classes with very few exceptions are just a
collection of static methods.  This has both the advantage and disadvantage
that the way the code is used in Java is similar to the way it is used in C.
This means the code does not resemble what a typical Java programmer expects
but it is easy for someone familiar with the C code to flow the flow of the
code.

The Java output is still in early development and is expected to change.
Since the Java output is just a thin layer on top of IoTivity-lite C code any
programs developed using Java are expected to be as stable as the underlying
C code.

Getting Started
=================================================
To use this code you will need the following:
  - git software control system
  - A local copy of IoTivity-lite
  - SWIG installed on your local system
  - Java Development kit.
  - C and C++ build tool for your desired system

### Get git
Git can be obtained for Windows [here](https://git-scm.com/download/win).

It can be installed on Ubuntu Linux using the following command.

    sudo apt-get install git

### Get Iotivity-Lite
Checkout IoTivity-lite git project run the following command to get a anonymous
copy of iotivity-lite (a.k.a. iotivity-constrained).  Checkout the SWIG branch.

    git clone https://gerrit.iotivity.org/gerrit/iotivity-constrained
    git checkout -t origin/swig

Since this is an anonymous download you will not be able to push any changes
up to the project. IoTivity is managed by the Linux Foundation.  If you are
planning on contributing back to IoTivity you will need to have a
[Linux Foundation ID](https://identity.linuxfoundation.org/).  The Linux
Foundation ID can then be used to log into the Gerrit server for IoTivity-lite.
[gerrit.iotivity.org](https://gerrit.iotivity.org/gerrit/#/admin/projects/iotivity-constrained)

Follow the instruction [here](https://wiki.iotivity.org/how_to_use_gerrit)
to gain push access to the project.

### Get SWIG
SWIG can be download [here](http://swig.org/download.html).

It can be installed on Ubuntu Linux using the following command.

    sudo apt-get install swig



### Get Java Development Kit
The SWIG output should work with Java 6 and newer. The Output has been
tested against Oracle Java 8 and OpenJDK 1.8.


Oracle Java 8 JDK can be
[downloaded here](https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html).

On Ubuntu Linux OpenJDK can be downloade using the following command.

    apt-get search openjdk
    sudo apt-get install openjdk-8-jdk
    # You may wish to choose a different version of openjdk
    # if you have installed multiple versions of Java you may need to switch
    # the active version using the update-java-alternatives tool.
    sudo apt-get install java-common
    update-java-alternatives

Install OpenJDK on Fedora Linux

    dnf search openjdk
    sudo dnf install java-1.8.0-openjdk.x86_64
    # or use dnf install <openjdk-package-name>
    # if you have installed multiple versions of Java you may need to switch
    # the active version
    sudo alternatives --config java

### C Build tools
#### Windows
For developement on Windows Visual Studio 2015 was used. The Visual Studio
solution files have been tested in newer version of Visual Studio and
have been found to work. Visual studio IDE Community edition and Visual
Studio Code should work but have not personally been tested. If you find that
the compiler does not work please give us feed back.

Download Visual Studio [here](https://visualstudio.microsoft.com/).

#### Linux
For Ubuntu Linux GCC compiler was used

    sudo apt-get build-essential

### Verify installation of needed tools
The scripts used assume all the needed tools are on PATH and are accessible
without knowing the location of the tool.

Run the following to verify each tool

---
bash shell (windows only) For me this was installed with git

    sh --version

example of expected output

    GNU bash, version 4.4.12(2)-release (x86_64-pc-msys)
    Copyright (C) 2016 Free Software Foundation, Inc.
    License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>

---
git

    git --version

example of expected output

    git version 2.16.1.windows.1

---
SWIG

    swig -version

example of expected output

    SWIG Version 3.0.12
    Compiled with i686-w64-mingw32-g++ [i686-w64-mingw32]
    Configured options: +pcre
    Please see http://www.swig.org for reporting bugs and further information

---
Java

    java -version
    javac -version

example of expected output

    java version "1.8.0_144"
    Java(TM) SE Runtime Environment (build 1.8.0_144-b01)
    Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)

    javac 1.8.0_144

Building
=================================================
### Building for Windows
Navigate to `<iotivity-lite>/swig/java_lang`
Get SWIG to generate the Java and JNI code:

    sh build_swig.sh

This will generate several C and C++ files in the same directory as the
`build_swig` script.  It will also generate many `*.java` files in the
`<iotivity-lite>/swig/iotivity-lite-eclipse-project/src/org/iotivity`
directory. It will also copy the files found in `<iotivity-lite>/swig/oc_java`
eclipe-project directory.

Build the JNI shared library:

Navigate to `<iotivity-lite>/port/windows/vs2015` open the Visual Studio
solution `IoTivity-Constrained.sln` file in Visual Studio.

Select the desired build options: Release/Debug, x86/x64. Note the x86/x64
must match the architecture of the Java VM that will be reading the library.
For example above when we run `java -version` we get
`Java HotSpot(TM) 64-Bit Server VM` this means we must select the x64
architecture for the build options. In the Solution Explorer right click on
the `iotivity-lite-jni` project. Select the `Build` option.

This will build
  - `IoTivity-Constrained.lib`
  - `iotivity-lite-jni.dll`

Copy the `iotivity-lite-jni.dll` file to the `<iotivity-lite>/swig/java_lang`
directory. We have scripts that will look for that library in that location.

NOTE: At the time of this writing the Debug variant of the build has security
disabled. This has been done to enable testing and development. Security can be
enabled by building the release build or by opening the project properties and
adding OC_SECURITY to the preprocessor definitions for the Debug build.

On success the Output window should show:

    ========== Build: 2 succeeded, 0 failed, 0 up-to-date, 0 skipped ==========


Build `iotivity-lite.jar` file:

    sh build-iotivity-lite.sh

### Building for Linux
Navigate to `<iotivity-lite>/swig/java_lang`
Get SWIG to generate the Java and JNI code:

    ./build_swig.sh

This will generate several C and C++ files in the same directory as the
`build_swig` script.  It will also generate many `*.java` files in the
`<iotivity-lite>/swig/iotivity-lite-eclipse-project/src/org/iotivity`
directory. It will also copy the files found in `<iotivity-lite>/swig/oc_java`
eclipe-project directory.

Build the JNI shared library `libiotivity-lite-jni.so`:

    ./build-jni-so.sh

Build `iotivity-lite.jar`:

    ./build-iotivity-lite.sh

### Building for Android
Follow the steps for Linux to generate the Java and JNI code and build the
`iotivity-lite.jar` i.e.

    ./build_swig.sh

    ./build-iotivity-lite.sh

Now copy the `iotivity-lite.jar` to the Android app libs directory:

    cp -v iotivity-lite.jar ../apps/android_simple_server/SimpleServer/app/libs/iotivity-lite.jar
    cp -v iotivity-lite.jar ../apps/android_simple_client/SimpleClient/app/libs/iotivity-lite.jar

Note that these commands are in the file `build-iotivity-lite.sh` and can be
uncommented-out.


To build the `libiotivity-lite-jni.so` shared object library for Android cd to
`<iotivity-lite>/android/port` and see the instructions in Makefile-swig.

Testing and Verifying
=================================================
### Building and Running Samples Windows
A sample server and client can be found in `<iotivity-lite>/swig/apps/<sample>`

The server sample is in `java_lite_simple_server`. To build and run the sample
execute the following commands.

    sh build-simple-server-lite.sh
    run-simple-server-lite.cmd

The client sample is in `java_lite_simple_client`. To build and run the sample
execute the following commands.

    sh build-simple-client-lite.sh
    run-simple-client-lite.cmd

### Building and Running Samples Linux
A sample server and client can be found in `<iotivity-lite>/swig/apps/<sample>`

The server sample is in `java_lite_simple_server`. To build and run the sample
execute the following commands.

    ./build-simple-server-lite.sh
    ./run-simple-server-lite.sh

The client sample is in `java_lite_simple_client`. To build and run the sample
execute the following commands.

    ./build-simple-client-lite.sh
    ./run-simple-client-lite.sh

### Building and Running Samples Android
A sample server and client can be found in `<iotivity-lite>/swig/apps/<sample>`

Note that gradlew will require a `local.properties` to exist or ANDROID_HOME
to be defined. An installation of Android Studio should create the
`local.properties` file.

The server sample is in `android_simple_server/SimpleServer`. To build and
install the sample execute the following command:

    ./gradlew installDebug

The client sample is in `android_simple_client/SimpleClient`. To build and
install the sample execute the following command:

    ./gradlew installDebug

Layout of swig folder
=================================================
This contains an overview of the contents of the `<iotivity-lite>/swig`
directory. With a summary of the contents of each directory.

    swig
    +-- apps
    |   +-- android_simple_client
    |   +-- android_simple_server
    |   +-- java_lite_simple_client
    |   |   +-- src
    |   +-- java_lite_simple_server
    |   |   +-- src
    +-- iotivity-lite-eclipse-project
    |   +-- junit
    |   +-- src
    +-- java_lang
    +-- oc_java
    +-- swig_interfaces

- `apps`  
Contains to client server samples. The `java_lite` samples have been run
and tested on Windows and Linux. The `android` samples are the same samples
with a really light UI for Android OS. The `java_lite` samples also contain
project files for the Eclipse IDE if users wish to import the samples into
that IDE.
- `iotivity-lite-eclipes-project`  
Contains unit test code in the `junit` directory as well as an empty `src`
directory.  The `src` directory will be populated with `*.java` files when
the SWIG build commands are run. This also contains project files for the
Eclipse IDE if user wishes to import the iotivity-lite code into Eclipse.
- `java_lang`  
Contains build scripts needed to generate the Java language binding using
SWIG. Some of the files generated by SWIG will be placed in this directory
as well as the `iotivity-lite-eclipse-project` directory. With the exception of
the scripts for building and running the samples all commands given in this
README are run from the `java_lang` directory.
- `oc_java`  
Contains Java files that are used by the SWIG output but not not generated
as part of the SWIG build process. Most of the files are Java interfaces used
to handle callbacks and bitmask values.
- `swig_interfaces`  
Contains the input files for the swig builder. These files contain
instructions for the SWIG builder. It tells it which header files are being
processed. It instructs swig how to rename files from a C style name with
underscores to a Java like lower camel case name. It also instructs swig how to
work with data types that it does not understand by default. Data types like
`oc_string_t`. It also contains code that works around the fact that Java
does not have a preprocessor so must handle many of the C macros differently.

Eclipse project files
=================================================
Where possible command line build scripts have been provided for building and
running the code. However much of the development was done using the Eclipse
IDE.  The project files have been committed so other developers can take
advantage of this powerful IDE if they wish.

To open the project files:
 - Open Eclipse
 - select `File->Import..`
 - select `General->Existing Projects into Workspace`
 - click `Next>` button
 - click the `Browse..` button next to the `Select root directory:` text box
 - browse to the `<iotivity-lite>\swig` directory click `OK`
 - make sure the checkbox for the three projects is checked. click `Finish`

Now you must tell eclipse the location of the `iotivity-lite-jni` shared
object file.  This is not by default since the location will differ on each
developers machine.

 - Right click on `iotivity-lite` project select `Properties`.
 - select `Java Build Path`
 - select `Libraries` tab
 - expand the `JRE System Library` option
 - select `Native library location` click `Edit..`
 - select `External Folder...`
 - browse to the location of the folder containing the `iotivity-lite-jni`
   click `OK`
 - Repeat the steps for `java_lite_sample_client` and `java_lite_sample_server`

Run the unit tests by right clicking on `iotivity-lite` project select
`Run As -> JUnit Test`. Selecting `Run As -> Java Application` will run the
command line version of the unit tests.

Run samples by right clicking on the sample select
`Run As -> Java Application`.

If the code was previously built using the command-line build scripts you may
get build warnings indicating some class files can not be found. Select
`Project -> Clean...`. Then right click on the `iotivity-lite` project and
select `Refresh`. This should force the project to rebuild the all the class
files associated with the `iotivity-lite.jar` file.

Send Feedback
=================================================
The SWIG generated language bindings are still in an early stage. The work
is subject to change. Feedback and bug reports are welcome please send them to
George Nash - george.nash (at) intel.com